<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="daedan.mes.haccp.project.pre_rec_mgmt.P0030">

    <select id="gridPaging" parameterType="map" resultType="camelMap">
        SELECT C.*
             ,(SELECT D.CODE_NM FROM SHC_COMM_CODE D WHERE SUBSTR(D.CODE_KIND,1,3)='APP' AND D.CODE = C.REVW_STATUS) AS REVW_STATUS
             ,(SELECT D.CODE_NM FROM SHC_COMM_CODE D WHERE SUBSTR(D.CODE_KIND,1,3)='APP' AND D.CODE = C.APPR_STATUS) AS APPR_STATUS
        FROM (
                 SELECT
                     A.REC_NO
                      ,STR_TO_DATE(A.CREATE_DT, '%Y-%m-%d') as CREATE_DT
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK1' THEN A.MEAS_VAL END) AS P1
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK2' THEN A.MEAS_VAL END) AS P2
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK3' THEN A.MEAS_VAL END) AS P3
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK4' THEN A.MEAS_VAL END) AS P4
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK5' THEN A.MEAS_VAL END) AS P5
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK6' THEN A.MEAS_VAL END) AS P6
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK7' THEN A.MEAS_VAL END) AS P7
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK8' THEN A.MEAS_VAL END) AS P8
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK9' THEN A.MEAS_VAL END) AS P9
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK10' THEN A.MEAS_VAL END) AS P10
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK1' THEN A.STD_VAL END) AS BK1
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK2' THEN A.STD_VAL END) AS BK2
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK3' THEN A.STD_VAL END) AS BK3
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK4' THEN A.STD_VAL END) AS BK4
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK5' THEN A.STD_VAL END) AS BK5
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK6' THEN A.STD_VAL END) AS BK6
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK7' THEN A.STD_VAL END) AS BK7
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK8' THEN A.STD_VAL END) AS BK8
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK9' THEN A.STD_VAL END) AS BK9
                      ,MAX(CASE WHEN A.M_CODE = 'LGTWRK10' THEN A.STD_VAL END) AS BK10
                      ,(SELECT B.REVW_STATUS FROM SHC_APPR_LIST B WHERE B.REC_NO = A.REC_NO) AS REVW_STATUS
                      ,(SELECT B.APPR_STATUS FROM SHC_APPR_LIST B WHERE B.REC_NO = A.REC_NO) AS APPR_STATUS
                 FROM (
                          SELECT
                              REC_NO
                               ,STR_TO_DATE(CREATE_DT, '%Y-%m-%d') as CREATE_DT
                               ,M_CODE
                               ,MEAS_VAL
                               ,STD_VAL
                          FROM SHC_REC_PRE_LIGHT
                          WHERE CREATE_DT BETWEEN STR_TO_DATE(#{start}, '%Y-%m-%d %H:%i:%s') AND STR_TO_DATE(CONCAT(#{end}, " 23:59:59"), '%Y-%m-%d %H:%i:%s')
                      )A
                 GROUP BY A.REC_NO,A.CREATE_DT
                 ORDER BY A.CREATE_DT DESC
             ) C
            LIMIT #{perPage} OFFSET #{offset}
    </select>

    <select id="selectColList" parameterType="map" resultType="camelMap">
        SELECT M_CODE,
               (SELECT CODE_NM FROM SHC_COMM_CODE A WHERE CODE_KIND='LGTWRK' AND CODE = M_CODE) M_CODE_NM
        FROM SHC_REC_PRE
        WHERE L_CODE = 'P0030'
          AND USE_YN = 'Y'
        ORDER BY ORD_SEQ
    </select>

    <select id="gridPagingCnt" parameterType="map" resultType="camelMap">
        SELECT COUNT(*)AS CNT FROM (SELECT REC_NO AS CNT
                                    FROM SHC_REC_PRE_LIGHT
                                    WHERE 1=1
                                      AND CREATE_DT BETWEEN STR_TO_DATE(#{start}, '%Y-%m-%d %H:%i:%s') AND STR_TO_DATE(CONCAT(#{end}, " 23:59:59"), '%Y-%m-%d %H:%i:%s')
                                    GROUP by REC_NO) CNT
    </select>


    <select id="selectInfo" parameterType="map" resultType="camelMap">
        SELECT
        A.REC_NO
        , A.SEQ
        , A.ORD_SEQ
        , A.M_CODE
        ,(SELECT B.CODE_NM FROM SHC_COMM_CODE B WHERE B.CODE_KIND='LGTWRK' AND B.CODE = A.M_CODE) M_CODE_NM
        , A.STD_VAL
        , A.MEAS_VAL
        , A.RMK
        , STR_TO_DATE(A.CREATE_DT, '%Y-%m-%d') as CREATE_DT
        , B.IMPRV_COMM AS IMPRV
        FROM SHC_REC_PRE_LIGHT A
        LEFT JOIN  SHC_REC_PRE_IMPRV B
        ON (B.REC_NO = A.REC_NO AND B.SEQ = A.SEQ)
        WHERE A.REC_NO = #{recNo}
        <!-- 				AND A.M_CODE= #{mCode} -->
    </select>

    <select id="selectColInfo" parameterType="map" resultType="camelMap">
        SELECT M_CODE, STD_VAL,
               (SELECT CODE_NM FROM SHC_COMM_CODE A WHERE CODE_KIND='LGTWRK' AND CODE = M_CODE) M_CODE_NM
        FROM SHC_REC_PRE
        WHERE L_CODE = 'P0030'
          and M_CODE = #{mCode}
    </select>

    <insert id="insertPreLight" parameterType="map">
        INSERT INTO SHC_REC_PRE_LIGHT
        (
            REC_NO
        , SEQ
        , ORD_SEQ
        , M_CODE_KIND
        , M_CODE
        , STD_VAL
        , MEAS_VAL
        , RMK
        , CREATE_ID
        , CREATE_DT
        )VALUES(
                   #{newRecNo},
                   ( SELECT COALESCE (MAX(A.SEQ),0)+1 FROM SHC_REC_PRE_LIGHT A WHERE A.REC_NO =#{newRecNo} ),
                   ( SELECT COALESCE (MAX(B.ORD_SEQ),0)+1 FROM SHC_REC_PRE_LIGHT B WHERE B.REC_NO =#{newRecNo} ),
                   'LGTWRK',
                   #{mCode},
                   (SELECT STD_VAL FROM SHC_REC_PRE WHERE L_CODE = 'P0030' AND M_CODE = #{mCode}),
                   #{measVal},
                   #{rmk},
                   #{userId},
                   STR_TO_DATE(NOW(), '%Y-%m-%d %H:%i:%s')
               )
    </insert>

    <insert id="insertPreLight2" parameterType="map">
        INSERT INTO SHC_REC_PRE_LIGHT
        (
            REC_NO
        , SEQ
        , ORD_SEQ
        , M_CODE_KIND
        , M_CODE
        , STD_VAL
        , MEAS_VAL
        , RMK
        , CREATE_ID
        , CREATE_DT
        )VALUES(
                   #{recNo},
                   ( SELECT COALESCE (MAX(SEQ),0)+1 FROM SHC_REC_PRE_LIGHT WHERE REC_NO =#{recNo} ),
                   ( SELECT COALESCE (MAX(ORD_SEQ),0)+1 FROM SHC_REC_PRE_LIGHT WHERE REC_NO =#{recNo} ),
                   'LGTWRK',
                   #{mCode},
                   (SELECT STD_VAL FROM SHC_REC_PRE WHERE L_CODE = 'P0030' and M_CODE = #{mCode}),
                   #{measVal},
                   #{rmk},
                   #{userId},
                   STR_TO_DATE(NOW(), '%Y-%m-%d %H:%i:%s')
               )
    </insert>
    <update id="updateLight" parameterType="map">
        UPDATE SHC_REC_PRE_LIGHT
        SET
            MEAS_VAL = #{measVal}
          ,RMK = #{rmk}
          ,MODIFY_ID = #{userId}
          ,MODIFY_DT = STR_TO_DATE(NOW(), '%Y-%m-%d %H:%i:%s')
        WHERE 1=1
          AND REC_NO = #{recNo}
          AND SEQ = #{seq}
    </update>

    <delete id="deleteLight" parameterType="map">
        DELETE FROM SHC_REC_PRE_LIGHT WHERE REC_NO = #{recNo}
    </delete>

    <select id="selectPreImprv" parameterType="map" resultType="camelMap">
        SELECT REC_NO, SEQ, BREAK_YN, BREAK_REASON, IMPRV_YN, IMPRV_COMM, RMK
        FROM SHC_REC_PRE_IMPRV
        WHERE 1=1
          AND REC_NO = #{recNo}
          AND SEQ = #{seq}
    </select>

    <update id="updatePreImprv" parameterType="map">
        UPDATE SHC_REC_PRE_IMPRV SET
                                     IMPRV_COMM = #{imprv},
                                     MODIFY_ID = #{userId},
                                     MODIFY_DT = STR_TO_DATE(NOW(), '%Y-%m-%d %H:%i:%s')
        WHERE REC_NO = #{recNo}
          AND SEQ = #{seq}
    </update>


    <insert id="insertPreImprv" parameterType="map" >
        INSERT INTO SHC_REC_PRE_IMPRV
        (
            REC_NO,
            SEQ,
            BREAK_YN,
            IMPRV_YN,
            IMPRV_COMM,
            CREATE_ID,
            CREATE_DT
        ) VALUES
            (
                #{newRecNo},
                ( SELECT COALESCE (MAX(SEQ),0) FROM SHC_REC_PRE_LIGHT WHERE REC_NO =#{newRecNo} ),
                'Y',
                'Y',
                #{imprv},
                #{userId},
                STR_TO_DATE(NOW(), '%Y-%m-%d %H:%i:%s')
            )
    </insert>

    <insert id="insertPreImprv2" parameterType="map" >
        INSERT INTO SHC_REC_PRE_IMPRV
        (	REC_NO,
             SEQ,
             BREAK_YN,
             IMPRV_YN,
             IMPRV_COMM,
             CREATE_ID,
             CREATE_DT)
        VALUES
            (#{recNo},
             #{seq},
             'Y',
             'Y',
             #{imprv},
             #{userId},
             STR_TO_DATE(NOW(), '%Y-%m-%d %H:%i:%s')
            )
    </insert>

    <update id="updatePreCleanImprv" parameterType="map">
        UPDATE SHC_REC_PRE_IMPRV SET
                                     IMPRV_COMM = #{imprv},
                                     MODIFY_ID = #{userId},
                                     MODIFY_DT = STR_TO_DATE(NOW(), '%Y-%m-%d %H:%i:%s')
        WHERE REC_NO = #{recNo}
          AND SEQ = #{seq}
    </update>

    <delete id="deletePreCleanImprv" parameterType="map">
        DELETE FROM SHC_REC_PRE_IMPRV WHERE REC_NO = #{recNo}
    </delete>

    <select id="selectFinalCheckList" parameterType="map" resultType="camelMap">
        /* [조도관리 - 인증원으로 보낼 체크 리스트 가져오기] pre_rec_mgmt.p0030.selectFinalCheckList */
        SELECT A.LCNS_NO, A.COMPANY_NM, A.CREATE_DATE, A.CREATE_TIME, A.APPR_YN, A.REC_CODE, A.REC_NM, A.SEQ, A.WP_NM, A.STD_VAL, A.MEAS_VAL, A.BREAK_YN, A.IMPRV_COMM
        FROM (
                 SELECT  #{lcnsNo} AS LCNS_NO,
                         #{companyNm} AS COMPANY_NM,
                         DATE_FORMAT(A.CREATE_DT, '%Y-%m-%d') AS CREATE_DATE,
                         DATE_FORMAT(A.CREATE_DT, '%H:%i:%s') AS CREATE_TIME,
                         'Y' AS APPR_YN,
                         #{lCode} AS REC_CODE,
                         #{lCodeNm} AS REC_NM,
                         A.ORD_SEQ AS SEQ,
                         (SELECT B.CODE_NM FROM SHC_COMM_CODE B WHERE B.CODE_KIND='LGTWRK' AND B.CODE = A.M_CODE) AS WP_NM,
                         A.STD_VAL,
                         A.MEAS_VAL,
                         CASE B.BREAK_YN WHEN 'Y' then 'Y' ELSE 'N' END AS BREAK_YN,
                         B.IMPRV_COMM,
                         A.ORD_SEQ,
                         A.REC_NO
                 FROM SHC_REC_PRE_LIGHT A
                          LEFT JOIN  SHC_REC_PRE_IMPRV B
                                     ON (B.REC_NO = A.REC_NO AND B.SEQ = A.SEQ)
                 WHERE 1=1
                   AND A.REC_NO = #{recNo}
             ) A
        ORDER BY A.REC_NO, ORD_SEQ ASC
    </select>

    <select id="selectFinalImprv" parameterType="map" resultType="camelMap">
        /* [조도관리 - 인증원으로 보낼 개선 조치 가져오기] pre_rec_mgmt.p0030.selectFinalImprv */
        SELECT #{lcnsNo} AS LCNS_NO,
               #{companyNm} AS COMPANY_NM,
               DATE_FORMAT(CREATE_DT, '%Y-%m-%d') AS CREATE_DATE,
               DATE_FORMAT(CREATE_DT, '%H:%i:%s') AS CREATE_TIME,
               'Y' AS APPR_YN,
               #{lCode} AS REC_CODE,
               #{lCodeNm} AS REC_NM,
               SEQ AS SEQ,
               IMPRV_COMM
        FROM SHC_REC_PRE_IMPRV
        WHERE 1=1
          AND REC_NO = #{recNo}

    </select>

    <select id="selectPlaceList" parameterType="map" resultType="camelMap">
        SELECT A.L_CODE, A.SEQ, A.ORD_SEQ, A.M_CODE_KIND, A.M_CODE,
               (SELECT B.CODE_NM FROM SHC_COMM_CODE B WHERE B.CODE_KIND = A.M_CODE_KIND AND B.CODE = A.M_CODE) AS M_CODE_NM,
               (SELECT B.CODE_DESC FROM SHC_COMM_CODE B WHERE B.CODE_KIND = A.M_CODE_KIND AND B.CODE = A.M_CODE) AS M_CODE_DESC,
               STD_VAL,
               STD_VAL1
        FROM SHC_REC_PRE A
        WHERE 1=1
          AND L_CODE = #{recLargeCode}
          AND USE_YN = 'Y'
        ORDER BY ORD_SEQ ASC
    </select>
</mapper>