<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="daedan.mes.haccp.project.pre_rec_mgmt.P0160">

    <select id="gridPaging" parameterType="map" resultType="camelMap">
        SELECT
        D.REC_NO
        , date_format(str_to_date (D.CREATE_DT, '%Y-%m-%d %H:%i:%s' ), '%Y-%m-%d') as CREATE_DT
        , (SELECT F.CODE_NM FROM SHC_COMM_CODE F WHERE SUBSTR(F.CODE_KIND,1,3)='APP' AND F.CODE = D.REVW_STATUS) AS REVW_STATUS
        , (SELECT F.CODE_NM FROM SHC_COMM_CODE F WHERE SUBSTR(F.CODE_KIND,1,3)='APP' AND F.CODE = D.APPR_STATUS) AS APPR_STATUS
        , D.REG_DATE
        , D.L_CODE
        , D.ITEM_CODE_KIND
        , D.ITEM_CODE
        , (SELECT Z.CODE_NM FROM SHC_COMM_CODE Z WHERE Z.CODE_KIND = D.ITEM_CODE_KIND AND Z.CODE = D.ITEM_CODE)AS ITEM_CODE_NM
        , D.FILE_KEY
        , D.RMK
        , D.CREATE_ID
        , D.CREATE_DT
        , D.L_CODE_NM
        FROM (SELECT A.REC_NO, A.CREATE_DT, A.REG_DATE, A.L_CODE, B.ITEM_CODE_KIND, B.ITEM_CODE, B.FILE_KEY, B.RMK, B.CREATE_ID
        ,(SELECT E.REVW_STATUS FROM SHC_APPR_LIST E WHERE E.REC_NO = A.REC_NO) AS REVW_STATUS
        ,(SELECT G.APPR_STATUS FROM SHC_APPR_LIST G WHERE G.REC_NO = A.REC_NO) AS APPR_STATUS
        ,(SELECT L_CODE_NM FROM SHC_REC_MAIN SRM WHERE SRM.L_CODE = A.L_CODE) AS L_CODE_NM
        FROM SHC_REC_PRE_LIST A, SHC_REC_PRE_COMM B
        WHERE A.REC_NO=B.REC_NO
        AND A.L_CODE =  #{recLargeCode}
        AND A.CREATE_DT BETWEEN STR_TO_DATE(#{start},'%Y-%m-%d') AND STR_TO_DATE(CONCAT(#{end},' 23:59:59'), '%Y-%m-%d %H:%i:%s')
        <if test="itemCodeNm != null and itemCodeNm != '' and itemCodeNm != 'undefined'">
            AND (SELECT C.CODE_NM FROM SHC_COMM_CODE C WHERE C.CODE_KIND = B.ITEM_CODE_KIND AND C.CODE = B.ITEM_CODE) LIKE CONCAT('%', #{itemCodeNm}, '%')
        </if>) D
        ORDER BY D.CREATE_DT DESC
        LIMIT #{perPage} OFFSET #{offset}
    </select>

    <select id="gridPagingCnt" parameterType="map" resultType="camelMap">
        SELECT COUNT(*) AS CNT
        FROM SHC_REC_PRE_LIST A, SHC_REC_PRE_COMM B
        WHERE A.REC_NO=B.REC_NO
        AND A.L_CODE = #{recLargeCode}
        AND A.CREATE_DT BETWEEN STR_TO_DATE(#{start},'%Y-%m-%d') AND STR_TO_DATE(CONCAT(#{end},' 23:59:59'), '%Y-%m-%d %H:%i:%s')
        <if test="itemCodeNm != null and itemCodeNm != '' and itemCodeNm != 'undefined'">
            AND (SELECT C.CODE_NM FROM SHC_COMM_CODE C WHERE C.CODE_KIND = B.ITEM_CODE_KIND AND C.CODE = B.ITEM_CODE) LIKE CONCAT('%', #{itemCodeNm}, '%')
        </if>
    </select>

    <select id="selectCreateDt" parameterType="map" resultType="camelMap">
        SELECT max(date_format(A.CREATE_DT, '%Y-%m-%d')) as REC_DT
        FROM SHC_REC_PRE_LIST A, SHC_REC_PRE_COMM B
        WHERE A.REC_NO = B.REC_NO
          AND A.L_CODE =  #{recLargeCode}
          AND B.ITEM_CODE = #{itemCode}
    </select>


    <select id="selectInfo" parameterType="map" resultType="camelMap">
        SELECT A.REC_NO, A.REG_DATE , A.L_CODE, B.SEQ as REC_SEQ, B.ITEM_CODE_KIND, B.ITEM_CODE,
               (SELECT C.CODE_NM FROM SHC_COMM_CODE C WHERE C.CODE_KIND = B.ITEM_CODE_KIND AND C.CODE = B.ITEM_CODE)AS ITEM_CODE_NM,
               B.FILE_KEY, B.RMK, A.CREATE_ID, A.CREATE_DT, A.MODIFY_ID, A.MODIFY_DT
        FROM SHC_REC_PRE_LIST A, SHC_REC_PRE_COMM B
        WHERE A.REC_NO=B.REC_NO
          AND A.REC_NO = #{recNo}
    </select>

    <select id="selectItemList" parameterType="map" resultType="camelMap">
        SELECT A.L_CODE, A.SEQ, A.ORD_SEQ, A.M_CODE_KIND, A.M_CODE,
               (SELECT B.CODE_NM FROM SHC_COMM_CODE B WHERE B.CODE_KIND = A.M_CODE_KIND AND B.CODE = A.M_CODE) AS M_CODE_NM
        FROM SHC_REC_PRE A
        WHERE 1=1
          AND L_CODE = #{recLargeCode}
          AND USE_YN = 'Y'
        ORDER BY ORD_SEQ ASC
    </select>


    <insert id="insertRecPre" parameterType="map">
        INSERT INTO SHC_REC_PRE_LIST
        (	REC_NO,
             REG_DATE,
             L_CODE,
             ITEM_CODE_KIND,
             ITEM_CODE,
             ITEM_CODE_NM,
             CYCLE,
             RMK,
             CREATE_ID,
             CREATE_DT)
        VALUES
            (   CONCAT(#{recLargeCode},date_format(current_timestamp(),'%Y%m%d%H%i%s')),
                current_date(),
                #{recLargeCode},
                (SELECT B.REF_COMM_CODE FROM SHC_REC_MAIN B WHERE B.L_CODE = #{recLargeCode}),
                #{itemCode},
                (SELECT B.CODE_NM FROM SHC_COMM_CODE B WHERE B.CODE_KIND = #{itemCodeKind} AND B.CODE = #{itemCode}),
                #{cycle},
                #{rmk},
                #{userId},
                current_timestamp()
            )
    </insert>

    <select id="selectFinalCheckList" parameterType="map" resultType="camelMap">
        /* [검교정관리 - 인증원으로 보낼 체크 리스트 가져오기] pre_rec_mgmt.p0160.selectFinalCheckList */
        SELECT  #{lcnsNo} AS LCNS_NO,
                #{companyNm} AS COMPANY_NM,
                DATE_FORMAT(A.CREATE_DT, '%Y-%m-%d') AS CREATE_DATE,
                DATE_FORMAT(A.CREATE_DT, '%H:%i:%s') AS CREATE_TIME,
                'Y' AS APPR_YN,
                #{lCode} AS REC_CODE,
                #{lCodeNm} AS REC_NM,
                B.SEQ AS SEQ,
                (SELECT C.CODE_NM FROM SHC_COMM_CODE C WHERE C.CODE_KIND = B.ITEM_CODE_KIND AND C.CODE = B.ITEM_CODE) AS CALIB_NM,
                current_timestamp() AS TRNS_DT,
                CONCAT(#{lcnsNo},'_',DATE_FORMAT(A.CREATE_DT, '%Y%m%d'),'_',#{lCodeNm},'_',(SELECT C.CODE_NM FROM SHC_COMM_CODE C WHERE C.CODE_KIND = B.ITEM_CODE_KIND AND C.CODE = B.ITEM_CODE),(SELECT substr(FF.ORG_FILE_NM,instr(FF.org_file_nm,'.')) FROM SHC_COMM_FILES FF WHERE FF.FILE_KEY = B.FILE_KEY)) AS FILE_NM,
                A.REC_NO,
                A.RMK
        FROM SHC_REC_PRE_LIST A, SHC_REC_PRE_COMM B
        WHERE A.REC_NO=B.REC_NO
          AND A.REC_NO = #{recNo}
    </select>

    <select id="selectFinalImprv" parameterType="map" resultType="camelMap">
        /* [검교정관리 - 인증원으로 보낼 개선 조치 가져오기] pre_rec_mgmt.p0160.selectFinalImprv */
        SELECT #{lcnsNo} AS LCNS_NO,
               #{companyNm} AS COMPANY_NM,
               DATE_FORMAT(CREATE_DT, '%Y-%m-%d') AS CREATE_DATE,
               DATE_FORMAT(CREATE_DT, '%H:%i:%s') AS CREATE_TIME,
               'Y' AS APPR_YN,
               #{lCode} AS CODE,
               #{lCodeNm} AS REC_NM,
               SEQ AS SEQ,
               IMPRV_COMM,
               current_timestamp() AS TRNS_DT
        FROM SHC_REC_PRE_IMPRV
        WHERE 1=1
          AND REC_NO = #{recNo}

    </select>

    <select id="selectCountRecSeq" parameterType="map" resultType="camelMap">
        /* [검교정관리 - 인증원에서 받을 일자별 순번] pre_rec_mgmt.p0140.selectCountRecSeq */
        SELECT COUNT(*) AS CNT
        FROM SHC_REC_PRE_COMM A
                 INNER JOIN
             SHC_APPR_LIST B
             ON A.REC_NO = B.REC_NO
        WHERE 1=1
          AND B.NOW_APPR_STATUS = '200'
          AND A.ITEM_CODE_KIND = (SELECT B.REF_COMM_CODE FROM SHC_REC_MAIN B WHERE B.L_CODE = #{recLargeCode})
          AND DATE_FORMAT(A.CREATE_DT, '%Y-%m-%d') = #{todayString}
    </select>
</mapper>